<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Jobcenter Letter Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="app">
    <h1 id="title">Проверка письма Jobcenter</h1>
    <p id="subtitle">Помогаем понять, требуется ли действие по письму.</p>

    <div class="card">
      <h3>Язык</h3>
      <div class="lang-buttons">
        <button id="btnRu" type="button">RU Русский</button>
      </div>

      <p id="disclaimer">
        Это не юридическая консультация. Сервис показывает только: нужно ли действие по письму.
      </p>

      <!-- Upload -->
      <button id="uploadBtn" class="btn" type="button">Загрузить письмо</button>
      <input id="fileInput" type="file" accept="application/pdf,image/*" style="display:none" />

      <div id="fileInfo" style="margin-top:10px; opacity:0.95;"></div>

      <!-- Image preview -->
      <img id="imagePreview" alt="" style="display:none; margin-top:10px; width:100%; border-radius:12px;" />

      <!-- Tips -->
      <div id="tipsBox" style="display:none; margin-top:10px; padding:10px 12px; border-radius:12px; background:rgba(0,0,0,0.12);">
        <div style="font-weight:700; margin-bottom:6px;">Советы для хорошего OCR</div>
        <div style="white-space:pre-wrap; opacity:0.95;">
• Держите камеру ровно сверху (без наклона)
• Поднесите ближе: текст 70–90% кадра
• Уберите блики и тени
• Лучше яркий свет, чем тёмный кадр
• Если размыто — сделайте фото ещё раз
        </div>
      </div>

      <!-- Controls -->
      <button id="ocrBtn" class="btn" type="button" style="margin-top:10px; width:100%; display:none;">
        Распознать текст (OCR)
      </button>

      <button id="pdfBtn" class="btn" type="button" style="margin-top:10px; width:100%; display:none;">
        Извлечь текст из PDF
      </button>

      <div id="statusBox" style="margin-top:8px; opacity:0.9; display:none;"></div>

      <!-- DEBUG (важно для PDF в Telegram) -->
      <details id="debugWrap" style="margin-top:10px; display:none;">
        <summary style="cursor:pointer; opacity:0.9;">DEBUG (если PDF не работает)</summary>
        <pre id="debugBox" style="white-space:pre-wrap; margin-top:8px; padding:10px 12px; border-radius:12px; background:rgba(0,0,0,0.12); overflow:auto; max-height:220px;"></pre>
      </details>

      <!-- Text input -->
      <div style="margin-top:14px;">
        <label for="textInput" style="display:block; margin-bottom:8px; opacity:0.95;">
          Текст письма (можно вставить вручную)
        </label>

        <textarea
          id="textInput"
          rows="7"
          placeholder="Вставьте сюда текст письма Jobcenter…"
          style="width:100%; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.15); background:rgba(0,0,0,0.12); color:inherit; resize:vertical;"
        ></textarea>

        <button id="analyzeBtn" class="btn" type="button" style="margin-top:10px; width:100%;">
          Анализировать
        </button>
      </div>

      <!-- Result -->
      <div id="resultBox" style="display:none; margin-top:12px; padding:12px; border-radius:12px; background:rgba(0,0,0,0.12);">
        <div id="resultTitle" style="font-weight:700; margin-bottom:6px;"></div>
        <div id="resultDetails" style="white-space:pre-wrap; opacity:0.95;"></div>

        <div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.12);">
          <div style="font-weight:700; margin-bottom:6px;">Кратко о письме</div>
          <div id="aboutText" style="white-space:pre-wrap; opacity:0.95;"></div>
        </div>

        <div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.12);">
          <div style="font-weight:700; margin-bottom:6px;">Перевод (будет позже)</div>
          <div style="white-space:pre-wrap; opacity:0.95;">
Сделаем так: независимо от результата (“нужно действие” или нет) будет понятный перевод и объяснение письма.
Для качественного перевода подключим AI на следующем этапе.
          </div>
        </div>
      </div>

      <p class="hint" id="hint" style="margin-top:12px;">
        Фото → OCR → анализ запускается сам. PDF в Telegram иногда блокируется — тогда лучше загрузить фото/скриншот страницы.
      </p>
    </div>

    <small class="version">v1.1 · RU only · Debug for PDF in Telegram</small>
  </div>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Tesseract.js -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.js"></script>

  <script>
    // Telegram init (safe)
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) { tg.ready(); tg.expand(); }

    // pdf.js worker URL (может блокироваться, но оставим)
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.worker.min.js";
    }

    // DOM
    const btnRu = document.getElementById("btnRu");
    const uploadBtn = document.getElementById("uploadBtn");
    const fileInput = document.getElementById("fileInput");
    const fileInfo = document.getElementById("fileInfo");
    const imagePreview = document.getElementById("imagePreview");
    const tipsBox = document.getElementById("tipsBox");
    const ocrBtn = document.getElementById("ocrBtn");
    const pdfBtn = document.getElementById("pdfBtn");
    const statusBox = document.getElementById("statusBox");
    const debugWrap = document.getElementById("debugWrap");
    const debugBox = document.getElementById("debugBox");
    const textInput = document.getElementById("textInput");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const resultBox = document.getElementById("resultBox");
    const resultTitle = document.getElementById("resultTitle");
    const resultDetails = document.getElementById("resultDetails");
    const aboutText = document.getElementById("aboutText");

    // state
    let currentFile = null;
    let currentKind = null; // 'image' | 'pdf'
    let lastDownscaledCanvas = null;
    let autoTimer = null;

    function showStatus(msg) {
      statusBox.style.display = "block";
      statusBox.textContent = msg;
    }

    function showDebug(msg) {
      debugWrap.style.display = "block";
      debugBox.textContent = msg;
      // автоматически раскрываем, чтобы ты сразу видел причину
      debugWrap.open = true;
    }

    function resetUi() {
      fileInfo.textContent = "";
      imagePreview.style.display = "none";
      imagePreview.src = "";
      tipsBox.style.display = "none";
      ocrBtn.style.display = "none";
      pdfBtn.style.display = "none";
      statusBox.style.display = "none";
      statusBox.textContent = "";
      debugWrap.style.display = "none";
      debugBox.textContent = "";
      resultBox.style.display = "none";
      lastDownscaledCanvas = null;
    }

    // --- Analyzer ---
    function normalize(s) {
      return (s || "").toLowerCase().replace(/\s+/g, " ").trim();
    }

    function findDeadline(text) {
      const m1 = text.match(/\b(\d{1,2}\.\d{1,2}\.\d{2,4})\b/);
      if (m1) return m1[1];
      const m2 = text.match(/\b(bis zum|spätestens am|frist|fristen|bis spätestens)\s+(\d{1,2}\.\d{1,2}\.\d{2,4})\b/);
      if (m2) return m2[2];
      return "";
    }

    function analyzeText(raw) {
      const t = normalize(raw);
      if (t.length < 30) return { kind: "empty", deadline: "" };

      const actionSignals = [
        "bitte","wir bitten","sie werden gebeten","sie sind verpflichtet",
        "erforderlich","nachweisen","nachweis","einreichen","vorlegen",
        "termin","einladung","melden sie sich","rückmeldung",
        "frist","bis zum","spätestens","umgehend","sofort",
        "anhörung","mitwirkung","aufforderung","fehlende unterlagen",
        "unterlagen","kontoauszüge","mietvertrag","ausfüllen","formular"
      ];

      const infoSignals = [
        "bewilligung","bescheid","änderungsbescheid","mitteilung","information",
        "zahlung","auszahlung","überweisung","betrag",
        "wir informieren","zur kenntnis","hinweis","bewilligungsbescheid",
        "veränderungsmitteilung"
      ];

      let actionScore = 0, infoScore = 0;
      for (const w of actionSignals) if (t.includes(w)) actionScore++;
      for (const w of infoSignals) if (t.includes(w)) infoScore++;

      const deadline = findDeadline(t);

      if (actionScore >= 2 || (actionScore >= 1 && (t.includes("frist") || t.includes("termin") || deadline))) {
        return { kind: "needAction", deadline };
      }
      if (infoScore >= 2 && actionScore === 0) return { kind: "noAction", deadline: "" };
      return { kind: "unclear", deadline: "" };
    }

    function explainLetter(raw) {
      const t = normalize(raw);
      if (t.length < 30) return "Пока мало текста. Добавьте 1–2 абзаца из письма.";

      const hasTermin = /termin|einladung|melden sie sich|vorsprechen/.test(t);
      const hasDocs = /unterlagen|nachweis|nachweisen|einreichen|vorlegen|mitwirkung|aufforderung|fehlende|ausfüllen|formular/.test(t);
      const hasPay = /bürgergeld|zahlung|auszahlung|betrag|überweisung|monatlich/.test(t);
      const hasBescheid = /bescheid|änderungsbescheid|bewilligung|bewilligungsbescheid|mitteilung|veränderungsmitteilung/.test(t);

      if (hasTermin) return "Похоже на приглашение/термин. Обычно требуется действие: прийти/ответить.";
      if (hasDocs) return "Похоже на запрос документов/содействие. Обычно требуется действие: предоставить/дослать.";
      if (hasPay) return "Похоже на письмо о выплате/суммах. Часто это информирование.";
      if (hasBescheid) return "Похоже на решение/уведомление (Bescheid). Проверьте, есть ли просьба/срок.";
      return "Тип письма пока неясен. Добавьте основной абзац (где “Bitte/Frist/Termin”).";
    }

    function showResult(res) {
      resultBox.style.display = "block";

      if (res.kind === "empty") {
        resultTitle.textContent = "⚠️ Неясно — нужна проверка";
        resultDetails.textContent = "Введите/вставьте текст письма — хотя бы 2–3 строки.";
        aboutText.textContent = explainLetter(textInput.value || "");
        return;
      }

      if (res.kind === "needAction") {
        resultTitle.textContent = "✅ Требуется действие";
        resultDetails.textContent =
          "Похоже, Jobcenter ожидает от вас действие.\n" +
          (res.deadline ? ("Обнаружен возможный срок: " + res.deadline + "\n") : "") +
          "Проверьте, что именно требуют (документы/ответ/явка).";
      } else if (res.kind === "noAction") {
        resultTitle.textContent = "❌ Действие не требуется (скорее всего)";
        resultDetails.textContent =
          "Похоже, это уведомление/информация.\n" +
          "Если нет просьбы прислать документы/прийти/ответить — часто действие не требуется.\n" +
          "Если сомневаетесь — перепроверьте.";
      } else {
        resultTitle.textContent = "⚠️ Неясно — нужна проверка";
        resultDetails.textContent =
          "Сигналы неочевидны.\n" +
          "Добавьте 1–2 абзаца со сроком/термином (Bitte/Frist/Termin).";
      }

      aboutText.textContent = explainLetter(textInput.value || "");
    }

    function runAnalyzeNow() {
      const res = analyzeText(textInput.value || "");
      showResult(res);
    }

    function scheduleAutoAnalyze() {
      if (autoTimer) clearTimeout(autoTimer);
      autoTimer = setTimeout(() => runAnalyzeNow(), 800);
    }

    // --- OCR helpers ---
    async function downscaleImageToDataUrl(file, maxSide = 1600) {
      const img = new Image();
      const url = URL.createObjectURL(file);
      img.src = url;
      await new Promise((res, rej) => {
        img.onload = () => res();
        img.onerror = () => rej(new Error("Image load failed"));
      });

      const w = img.naturalWidth || img.width;
      const h = img.naturalHeight || img.height;
      const scale = Math.min(1, maxSide / Math.max(w, h));
      const nw = Math.round(w * scale);
      const nh = Math.round(h * scale);

      const canvas = document.createElement("canvas");
      canvas.width = nw;
      canvas.height = nh;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, nw, nh);

      URL.revokeObjectURL(url);
      return { dataUrl: canvas.toDataURL("image/jpeg", 0.9), canvas };
    }

    function cleanOcrText(t) {
      let s = (t || "");
      s = s.replace(/[^\S\r\n]+/g, " ");
      s = s.replace(/\n{3,}/g, "\n\n");
      s = s.replace(/[|}{]{2,}/g, " ");
      s = s.replace(/[^\p{L}\p{N}\s.,:;!?()+\-\/€$@%]/gu, "");
      s = s.replace(/\s{2,}/g, " ").trim();
      return s;
    }

    async function runTesseractOnDataUrl(dataUrl, prefix) {
      const lang = "deu+rus"; // RU-only
      const { data } = await Tesseract.recognize(dataUrl, lang, {
        logger: (m) => {
          if (m && m.status === "recognizing text" && typeof m.progress === "number") {
            const pct = Math.round(m.progress * 100);
            showStatus(prefix + " " + pct + "%");
          }
        }
      });
      return cleanOcrText((data && data.text) ? data.text : "");
    }

    // --- PDF parse (diagnostic only; Telegram WebView often blocks) ---
    async function tryOpenPdf(file) {
      const buf = await file.arrayBuffer();
      // пробуем без worker (часто безопаснее в WebView)
      return await pdfjsLib.getDocument({ data: buf, disableWorker: true }).promise;
    }

    async function extractTextFromPdf(pdf, maxPages = 2) {
      const total = pdf.numPages;
      const pages = Math.min(total, maxPages);
      let textAll = "";

      for (let i = 1; i <= pages; i++) {
        showStatus("Извлекаю текст из PDF: страница " + i + "/" + pages + "…");
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items
          .map(it => (it && it.str) ? it.str : "")
          .filter(Boolean);
        textAll += strings.join(" ") + "\n\n";
      }
      return textAll.trim();
    }

    // EVENTS
    btnRu.addEventListener("click", () => { /* RU only */ });

    uploadBtn.addEventListener("click", () => fileInput.click());

    textInput.addEventListener("input", () => scheduleAutoAnalyze());
    analyzeBtn.addEventListener("click", () => runAnalyzeNow());

    fileInput.addEventListener("change", async () => {
      resetUi();

      const file = fileInput.files && fileInput.files[0];
      if (!file) return;

      currentFile = file;

      const kb = Math.round(file.size / 1024);
      const mime = (file.type || "").toLowerCase();
      const isPdf = mime === "application/pdf" || file.name.toLowerCase().endsWith(".pdf");
      const isImage = mime.startsWith("image/");
      const typeLabel = mime ? mime : "unknown";

      fileInfo.textContent = `Файл: ${file.name} (${kb} KB) · Тип: ${typeLabel}`;

      if (isPdf) {
        currentKind = "pdf";
        pdfBtn.style.display = "block";
        showStatus("✅ PDF выбран. Нажмите «Извлечь текст из PDF».");
        // покажем debug-окно сразу, потому что PDF в Telegram часто проблемный
        showDebug(
          "ENV\n" +
          "- Telegram WebView: " + (tg ? "YES" : "NO") + "\n" +
          "- UserAgent: " + navigator.userAgent + "\n" +
          "- pdfjsLib loaded: " + (window.pdfjsLib ? "YES" : "NO") + "\n\n" +
          "Нажмите «Извлечь текст из PDF». Если упадёт — сюда попадёт точная ошибка."
        );
        return;
      }

      if (isImage) {
        currentKind = "image";

        const url = URL.createObjectURL(file);
        imagePreview.src = url;
        imagePreview.alt = file.name;
        imagePreview.style.display = "block";

        tipsBox.style.display = "block";
        ocrBtn.style.display = "block";
        showStatus("✅ Изображение выбрано. Можно нажать OCR.");

        try {
          const r = await downscaleImageToDataUrl(file, 1600);
          lastDownscaledCanvas = r.canvas;
        } catch (e) {}
        return;
      }

      currentKind = null;
      showStatus("⚠️ Неизвестный тип файла. Попробуйте PDF или изображение.");
    });

    ocrBtn.addEventListener("click", async () => {
      if (!currentFile || currentKind !== "image") return;

      try {
        ocrBtn.disabled = true;
        showStatus("OCR работает… 0%");

        let dataUrl;
        if (lastDownscaledCanvas) dataUrl = lastDownscaledCanvas.toDataURL("image/jpeg", 0.9);
        else dataUrl = (await downscaleImageToDataUrl(currentFile, 1600)).dataUrl;

        const cleaned = await runTesseractOnDataUrl(dataUrl, "OCR…");
        if (cleaned.length > 0) {
          textInput.value = cleaned;
          showStatus("✅ OCR готово. Текст вставлен. Анализ выполнен автоматически.");
          runAnalyzeNow(); // авто-анализ
        } else {
          showStatus("❌ OCR не получилось. Сделайте фото ближе/четче и без бликов.");
        }
      } catch (e) {
        showStatus("❌ OCR не получилось. Попробуйте ещё раз.");
      } finally {
        ocrBtn.disabled = false;
      }
    });

    pdfBtn.addEventListener("click", async () => {
      if (!currentFile || currentKind !== "pdf") return;

      pdfBtn.disabled = true;
      showStatus("Читаю PDF…");

      try {
        if (!window.pdfjsLib) {
          throw new Error("pdfjsLib not loaded (CDN blocked?)");
        }

        const pdf = await tryOpenPdf(currentFile);
        showStatus("PDF открыт. Пытаюсь извлечь текст…");

        const extracted = await extractTextFromPdf(pdf, 2);

        if (extracted && extracted.length >= 60) {
          textInput.value = extracted;
          showStatus("✅ Текст из PDF извлечён. Анализ выполнен автоматически.");
          runAnalyzeNow(); // авто-анализ
        } else {
          showStatus(
            "⚠️ Текст из PDF почти не извлекается. " +
            "В Telegram часто так бывает. " +
            "Лучший вариант: загрузите фото/скрин страницы и нажмите OCR."
          );
        }
      } catch (e) {
        // Сюда мы попадем в твоем случае — и теперь увидим точную причину
        showStatus("❌ Не удалось обработать PDF. Попробуйте фото/скрин письма.");
        showDebug(
          "PDF ERROR\n" +
          "- message: " + (e && e.message ? e.message : String(e)) + "\n\n" +
          "Что делать:\n" +
          "1) В Telegram Mini App загрузите НЕ PDF, а фото/скрин страницы → OCR работает стабильно.\n" +
          "2) Если хочешь именно PDF без ограничений Telegram — придётся делать обработку на сервере (Vercel API)."
        );
      } finally {
        pdfBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
