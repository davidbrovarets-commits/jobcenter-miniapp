<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jobcenter Letter Control</title>

  <link rel="stylesheet" href="style.css?v=31" />

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js?v=1"></script>

  <!-- Tesseract v5 -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js?v=5"></script>

  <!-- Tesseract explicit paths (CRITICAL for Telegram iOS) -->
  <script>
    window.TESSERACT_CFG = {
      workerPath: "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js",
      corePath: "https://cdn.jsdelivr.net/npm/tesseract.js-core@5/tesseract-core.wasm.js",
      langPath: "https://tessdata.projectnaptha.com/4.0.0"
    };
  </script>
</head>

<body>
<div class="app">

  <h1>Проверка письма Jobcenter</h1>
  <p class="subtitle">Определяем, требуется ли действие и есть ли дедлайн (MVP)</p>

  <div class="controls">
    <label class="btn">
      <input id="fileInput" type="file" accept="image/*" multiple hidden />
      Добавить страницы
    </label>

    <label>
      <input type="checkbox" id="toggleDeRu" />
      OCR: DE + RU (медленнее)
    </label>

    <label>
      <input type="checkbox" id="toggleShowDebug" checked />
      Показать debug
    </label>
  </div>

  <div id="progressText">—</div>
  <div class="progressLine"><div id="progressBar"></div></div>

  <img id="slideImg" style="max-width:100%; margin-top:10px;" />

  <button class="btn primary" id="btnAnalyze">Готово → Анализ</button>

  <pre id="debugBox" style="margin-top:10px; white-space:pre-wrap;"></pre>

</div>

<script>
/* ===========================
   STATE
=========================== */
const state = {
  worker: null,
  analyzing: false,
  locked: false
};

/* ===========================
   DOM
=========================== */
const el = {
  fileInput: document.getElementById("fileInput"),
  btnAnalyze: document.getElementById("btnAnalyze"),
  slideImg: document.getElementById("slideImg"),
  progressBar: document.getElementById("progressBar"),
  progressText: document.getElementById("progressText"),
  debugBox: document.getElementById("debugBox"),
  toggleDeRu: document.getElementById("toggleDeRu"),
};

/* ===========================
   TELEGRAM INIT (safe)
=========================== */
try {
  if (window.Telegram && window.Telegram.WebApp) {
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
  }
} catch (_) {}

/* ===========================
   TIMEOUT
=========================== */
function withTimeout(promise, ms, label) {
  let t;
  const timeout = new Promise((_, rej) => {
    t = setTimeout(() => rej(new Error(`TIMEOUT: ${label} (${ms}ms)`)), ms);
  });
  return Promise.race([promise, timeout]).finally(() => clearTimeout(t));
}

/* ===========================
   UI FAIL
=========================== */
function uiFail(msg, err) {
  console.error(msg, err || "");
  el.debugBox.textContent =
    msg + (err && err.message ? "\n\n" + err.message : "");
  el.progressText.textContent = msg;
  state.analyzing = false;
  setLocked(false);
}

/* ===========================
   GLOBAL ERROR TRAP
=========================== */
window.addEventListener("error", e => {
  uiFail(`JS ERROR: ${e.message}`, e.error);
});
window.addEventListener("unhandledrejection", e => {
  uiFail(`PROMISE ERROR: ${e.reason}`, e.reason);
});

/* ===========================
   HARD CHECK (after uiFail)
=========================== */
setTimeout(() => {
  if (!window.Tesseract) {
    uiFail(
      "Tesseract.js не загрузился. Telegram iOS блокирует CDN / Worker / WASM.",
      ""
    );
  }
}, 300);

/* ===========================
   UI LOCK
=========================== */
function setLocked(v) {
  state.locked = v;
  el.btnAnalyze.disabled = v;
}

/* ===========================
   WORKER INIT
=========================== */
async function ensureWorker() {
  if (state.worker) return state.worker;

  const cfg = window.TESSERACT_CFG;

  state.worker = await withTimeout(
    Tesseract.createWorker({
      workerPath: cfg.workerPath,
      corePath: cfg.corePath,
      langPath: cfg.langPath,
      logger: m => {
        if (m.progress)
          el.progressBar.style.width = Math.round(m.progress * 100) + "%";
      }
    }),
    20000,
    "createWorker"
  );

  await withTimeout(state.worker.loadLanguage("deu"), 20000, "loadLanguage");
  await withTimeout(state.worker.initialize("deu"), 20000, "initialize");

  return state.worker;
}

/* ===========================
   ANALYZE
=========================== */
el.btnAnalyze.onclick = async () => {
  if (state.analyzing) return;
  state.analyzing = true;
  setLocked(true);
  el.debugBox.textContent = "";
  el.progressText.textContent = "Подготовка OCR…";

  const watchdog = setTimeout(() => {
    uiFail(
      "OCR завис. Telegram iOS почти наверняка блокирует WebWorker/WASM.",
      ""
    );
  }, 20000);

  try {
    await ensureWorker();
    clearTimeout(watchdog);
    el.progressText.textContent = "OCR готов (движок запущен)";
  } catch (e) {
    clearTimeout(watchdog);
    uiFail("OCR не запустился", e);
  }
};

/* ===========================
   FILE LOAD (preview)
=========================== */
el.fileInput.onchange = e => {
  const f = e.target.files[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  el.slideImg.src = url;
};
</script>
</body>
</html>
